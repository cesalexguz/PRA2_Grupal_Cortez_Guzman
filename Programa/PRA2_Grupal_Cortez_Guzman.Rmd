---
title: "PRA2_Grupal_Cortez_Guzman"
author: "Bryan Cortéz, Cesar Guzman"
date: "28/12/2021"
output:
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
    includes:
      in_header: 75.584-PEC-header.html
  pdf_document:
    highlight: zenburn
    toc: yes
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval=T, echo=T)
```


# Importación de Datasets

A continuación procedemos a leer los archivos del directorio raíz del programa.

```{r message= FALSE, warning=FALSE}
library(dplyr)


ds1.covid<-read.csv("./Covid-19-Global-Dataset.csv",header=T,sep=",")
ds2.covid<-read.csv("./COVID-19-World-Vaccination-Progress.csv",header=T,sep=",")
```

# Descripción de los Datos

A continuación procedemos a mostrar la descripción de los datos.

Comenzamos por el primer dataset.

```{r message= FALSE, warning=FALSE}
str(ds1.covid)
```

Proseguimos viendo el segundo dataset.

```{r message= FALSE, warning=FALSE}
str(ds2.covid)
```

```{r message= FALSE, warning=FALSE}
suppressWarnings(unique(as.integer(format(ds1.covid$date, format="%Y"))))
```
```{r message= FALSE, warning=FALSE}
suppressWarnings(unique(as.integer(format(ds2.covid$date, format="%Y"))))
```


# Integración de los Datos

A continuación procedemos a mostrar la integración de los datos.

## Conversión de los Datos

```{r message= FALSE, warning=FALSE}
ds1.covid$date=as.Date(ds1.covid$date)
ds1.covid$year=as.integer(format(ds1.covid$date, format="%Y"))
ds1.covid$month=as.integer(format(ds1.covid$date, format="%m"))
```

Procedemos a filtrar los datos correspondiente al último día de cada mes de un año en específico.

```{r message= FALSE, warning=FALSE}
ds1.covid.modf = data.frame(ds1.covid %>% 
                  group_by(country,strftime(date, "%Y-%m")) %>% 
                  filter(date == max(date)))
```

Continuamos con la selección y reordenación de las columnas.

```{r message= FALSE, warning=FALSE}
ds1.covid.modf=data.frame(ds1.covid.modf[8:9],ds1.covid.modf[2:7])
```

Repetimos el procedimiento con el segundo dataset.

```{r message= FALSE, warning=FALSE}
ds2.covid$date=as.Date(ds2.covid$date)
ds2.covid$year=as.integer(format(ds2.covid$date, format="%Y"))
ds2.covid$month=as.integer(format(ds2.covid$date, format="%m"))
```

Continuamos con la selección y reordenación de las columnas.

```{r message= FALSE, warning=FALSE}
ds2.covid<-ds2.covid %>% select(c(1,3:12,16,17,13))
```


Procedemos a filtrar los datos correspondiente al último día de cada mes de un año en específico y de un país en específico.

```{r message= FALSE, warning=FALSE}
ds2.covid.modf = data.frame(ds2.covid %>% 
                  group_by(country,strftime(date, "%Y-%m")) %>% 
                  filter(date == max(date)))
```

Continuamos con la selección y reordenación de las columnas.

```{r message= FALSE, warning=FALSE}
ds2.covid.modf=data.frame(ds2.covid.modf[12:13],ds2.covid.modf[1],ds2.covid.modf[3:11],ds2.covid.modf[14])
```


## Integración de los Datos

Continuamos con la integración de los 2 conjuntos de datos.

```{r message= FALSE, warning=FALSE}
ds.covid.cst <- merge(ds1.covid.modf, ds2.covid.modf,by=c("country","year","month"))
```


# Limpieza de los Datos

## Visualización de datos vacíos

A continuación procedemos a Obtener cantidad de ceros por columna del conjunto de datos.

```{r message= FALSE, warning=FALSE}
cant.ceros <- data.frame(colSums(ds.covid.cst[4:17] == 0, na.rm = T))
names(cant.ceros) <- c("cantidad")
```

Vemos la cantidad total de ceros.

```{r message= FALSE, warning=FALSE}
sum(cant.ceros$cantidad)
```

Obtenemos la cantidad de valores NA

```{r message= FALSE, warning=FALSE}
cant.na <- data.frame(colSums(is.na(ds.covid.cst[4:17])))
names(cant.na) <- c("cantidad")
```

Vemos la cantidad total de valores NA.

```{r message= FALSE, warning=FALSE}
sum(cant.na$cantidad)
```


## Remplazo de los valores vacíos

Procedemos a reemplazar los valores vacíos por cero.

```{r message= FALSE, warning=FALSE}
ds.covid.cst[is.na(ds.covid.cst)] <- 0
```


## Guardado del conjunto de datos

Finalmente vemos como queda nuestro nuevo dataset antes de guardarlo.

```{r message= FALSE, warning=FALSE}
str(ds.covid.cst)
```

Procedemos a guardar el conjunto de datos.

```{r message= FALSE, warning=FALSE}
write.csv(x=ds.covid.cst, file="dataset_covid.csv")
```

# Análisis de datos

Para temas prácticos, vamos a enfocarnos en analizar cuatro países con los cuales haremos las comparativas. Para ellos escogimos a Ecuador, porque es el país de los dos miembros que integran este equipo; España, que es el único  país desarrollado de habla hispana y el cual sirve de referencia para las comparativas respecto a los países de Latinoamérica; Alemania, por ser el país más rico de la Unión Europea y uno de los que aparentemente sobrellevaron al inicio la pandemia y por último, Estados Unidos, que es el país más rico del mundo, pero que tuvo bastantes dificultades sobrellevando la pandemia, al menos al inicio.
Por tanto, vamos a proceder analizando que tal lo ha hecho nuestro país frente a las grandes potencias mundiales.

```{r message= FALSE, warning=FALSE}
ds.covid.info_ec <- ds.covid.cst[ds.covid.cst$country == "Ecuador",]
ds.covid.info_es <- ds.covid.cst[ds.covid.cst$country == "Spain",]
ds.covid.info_de <- ds.covid.cst[ds.covid.cst$country == "Germany",]
ds.covid.info_us <- ds.covid.cst[ds.covid.cst$country == "United States",]


filas_ec=dim(ds.covid.info_ec)[1]
filas_es=dim(ds.covid.info_es)[1]
filas_de=dim(ds.covid.info_de)[1]
filas_us=dim(ds.covid.info_us)[1]
filas_total=dim(ds.covid.cst)[1]
```

## Comprobación de la normalidad y homogeneidad de la varianza 

Vamos a proceder comprobando los valores que toman las variables cuantitativas provienen de una población distribuida normalmente, para ello utilizaremos la prueba de normalidad de Anderson-Darling.

Para ello, vamos a comprobar cada variable si obtiene un p-valor superior al nivel de significación prefijado α = 0, 05. Si esto se cumple, entonces se considera que variable en cuestión sigue una distribución normal.

```{r message= FALSE, warning=FALSE}
library(nortest)


alpha = 0.05
col.names = colnames(ds.covid.cst)
for (i in 1:ncol(ds.covid.cst)) {
  if (i == 1) cat("Variables que no siguen una distribución normal:\n")
  if (is.integer(ds.covid.cst[,i]) | is.numeric(ds.covid.cst[,i])) {
    p_val = ad.test(ds.covid.cst[,i])$p.value
    if (p_val < alpha) {
      cat(col.names[i])

      if (i < ncol(ds.covid.cst) - 1) cat(", ")
      if (i %% 3 == 0) cat("\n")
    }
  }
}
```

Continuamos con la homogeneidad de varianzas mediante la aplicación de un test de Fligner-Killeen. Para ello, estudiaremos esta homogeneidad en cuanto a los grupos conformados por las casos acumulados y las muertes acumuladas. En el siguiente test, la hipótesis nula consiste en que ambas varianzas son iguales.

```{r message= FALSE, warning=FALSE}
fligner.test(cumulative_total_cases ~ cumulative_total_deaths, data = ds.covid.cst)
```

Como podemos ver, el valor obtenido de p-value es inferior al aceptado de 0.05, desestimamos que la hipótesis de que las varianzas de ambas muestras sean homogéneas.


## Pruebas Estadísticas

```{r message= FALSE, warning=FALSE}
if(!require(ggplot2)){
    install.packages('ggplot2', repos='http://cran.us.r-project.org')
    library(ggplot2)
}

if(!require(ggpubr)){
    install.packages('ggpubr', repos='http://cran.us.r-project.org')
    library(ggpubr)
}

if(!require(grid)){
    install.packages('grid', repos='http://cran.us.r-project.org')
    library(grid)
}

if(!require(gridExtra)){
    install.packages('gridExtra', repos='http://cran.us.r-project.org')
    library(gridExtra)
}

if(!require(C50)){
    install.packages('C50', repos='http://cran.us.r-project.org')
    library(C50)
}
```

Primero, comenzaremos con un análisis visual de los datos del último año. Viendo de la distribución de casos diarios, casos acumulados, decesos y vacunación en el tiempo en Ecuador.

Como se puede visualizar en la primera gráfica, vemos que a partir de mayo de 2021, cuando se posicionó el nuevo gobierno, comenzaron a descender los casos nuevos casos, gracias a la implementación del nuevo plan de vacunación. Lo mismo se puede ver en las otras gráficas que se marca una diferencia a partir de mayo en las tendencias, empezando desde abajo hasta llegar al punto de la nueva ola formada por las variantes Delta y Omicron.


```{r message= FALSE, warning=FALSE}
plot(ds.covid.info_ec$daily_new_cases)

plot(ds.covid.info_ec$cumulative_total_cases)

plot(ds.covid.info_ec$cumulative_total_deaths)

plot(ds.covid.info_ec$people_fully_vaccinated)

```

Continuamos viendo la distribución de casos diarios, casos acumulados, decesos y vacunación en el tiempo en España.

En el caso de España, podemos ver una tendencia totalmente diferente y errática de los nuevos casos diarios, ya que no hay una tendencia clara, se puede ver un repunte en el verano, pero luego un descenso, sin embargo, en octubre por alguna razón vemos dispararse los contagios a nivel récord en todo el año. En el caso de los contagios se ve algo similar a Ecuador, con la marca de cada ola de la pandemia, sin embargo, en el caso de las muertes se ve una más abultada la ola que la del Ecuador. Y por otro lado en la vacunación se ve como a partir de julio empieza una vacunación exponencial.

```{r message= FALSE, warning=FALSE}
plot(ds.covid.info_es$daily_new_cases)

plot(ds.covid.info_es$cumulative_total_cases)

plot(ds.covid.info_es$cumulative_total_deaths)

plot(ds.covid.info_es$people_fully_vaccinated)

```

Continuamos viendo la distribución de casos diarios, casos acumulados, decesos y vacunación en el tiempo en Alemania.

En el caso de Alemania vemos algo totalmente diferente, su pico más alto de nuevos casos diarios fue en mayo, justo a puertas del verano, sin embargo y curiosamente, vemos que en junio comienza un descenso drástico, hasta que en noviembre vemos escalar un poco los contagios, presuntamente por la nueva variante omicron. En el gráfico de los casos y muertes acumuladas, se ven similares a España, con las marcadas olas que se dieron este año, y la vacunación igualmente desde junio se ve como empieza a escalar.

```{r message= FALSE, warning=FALSE}
plot(ds.covid.info_de$daily_new_cases)

plot(ds.covid.info_de$cumulative_total_cases)

plot(ds.covid.info_de$cumulative_total_deaths)

plot(ds.covid.info_de$people_fully_vaccinated)

```

Continuamos viendo la distribución de casos diarios, casos acumulados, decesos y vacunación en el tiempo en Estados Unidos.

Por último, en el caso de Estados Unidos, en los nuevos casos diarios, se ve un comportamiento errático como el de España, pero con la diferencia que su pico más alto está en enero, probablemente porque se asumían las consecuencias del descuido de Trump en el manejo de la pandemia, y las medidas tomadas por Biden todavía no tenían efecto. En cuanto al resto de gráficas, el comportamiento es similar al de Alemania, se marcan las olas, y la vacunación empieza a crecer bastante a partir de junio.

```{r message= FALSE, warning=FALSE}
plot(ds.covid.info_us$daily_new_cases)

plot(ds.covid.info_us$cumulative_total_cases)

plot(ds.covid.info_us$cumulative_total_deaths)

plot(ds.covid.info_us$people_fully_vaccinated)

```


### Correlación de variables

Procedemos a realizar un análisis de correlación entre todas las variables para determinar cuáles de ellas ejercen una mayor influencia sobre el total de muertes acumuladas. Para lo cual usaremos el método de Spearman, puesto que hemos visto que tenemos datos que no siguen una distribución normal, por lo que no nos sirve el de Pearson. Adicionalmente cada coeficiente de correlación también muestra el p-valor asociado, para dar más información.

```{r message= FALSE, warning=FALSE}


corr_matrix <- matrix(nc = 2, nr = 0)
colnames(corr_matrix) <- c("estimate", "p-value")

for (i in 1:(ncol(ds.covid.cst) - 1)) {
  if (is.integer(ds.covid.cst[,i]) | is.numeric(ds.covid.cst[,i])) {
    spearman_test = cor.test(ds.covid.cst[,i],
                             ds.covid.cst[,7],
                             method = "spearman")
    corr_coef = spearman_test$estimate
    p_val = spearman_test$p.value

    pair = matrix(ncol = 2, nrow = 1)
    pair[1][1] = corr_coef
    pair[2][1] = p_val
    corr_matrix <- rbind(corr_matrix, pair)
    rownames(corr_matrix)[nrow(corr_matrix)] <- colnames(ds.covid.cst)[i]
  }
}

print(corr_matrix)

```

Como podemos ver las variables más correlacionadas con el total de muertes acumuladas en función de su proximidad con los valores -1 y +1 son el total de casos acumulados, los casos activos, los nuevos casos diarios, las muertes diarias y las vacunaciones diarias


### Prueba de Contraste

La segunda prueba estadística que vamos a realizar, será una prueba de contraste de hipótesis, la cual plantea que "La proporción de muertes por Covid-19 es menor en los países desarrollados?"
Para ello, usaremos la comparativa de Ecuador, con España, Alemania y Estados Unidos, que tienen un PIB per cápita entre 6, 10 y 12 veces mayor respectivamente, por lo que en teoría deberían tener un mejor sistema de salud.

```{r message= FALSE, warning=FALSE}

t.test(ds.covid.info_ec$cumulative_total_deaths, ds.covid.info_es$cumulative_total_deaths, alternative = "less")

t.test(ds.covid.info_ec$cumulative_total_deaths, ds.covid.info_de$cumulative_total_deaths, alternative = "less")

t.test(ds.covid.info_ec$cumulative_total_deaths, ds.covid.info_us$cumulative_total_deaths, alternative = "less")
```

Si tomamos un α=0.05, entonces vemos que nuestrop-value en todos los casos es menor que el valor de significación fijado. Por tanto vemos que se cumple lo propuesto en la hipótesis. 

Aunque si comparamos la proporción de las muertes acumuladas con respecto a la población de cada país, vemos que únicamente Alemania, es el único que realmente tiene una proporción baja de muertes, ya que los otros países sobrepasan el 2%, por lo que podemos decir que no basta la riqueza del país, sino también la gestión y la cultura de cada país para evitar mayor proporción de decesos. 

```{r message= FALSE, warning=FALSE}

sum(ds.covid.info_ec$cumulative_total_deaths)

sum(ds.covid.info_es$cumulative_total_deaths)

sum(ds.covid.info_de$cumulative_total_deaths)

sum(ds.covid.info_us$cumulative_total_deaths)

p_ec <- (sum(ds.covid.info_ec$cumulative_total_deaths) / 17640000) * 100

p_es <- (sum(ds.covid.info_es$cumulative_total_deaths) / 47350000) * 100

p_de <- (sum(ds.covid.info_de$cumulative_total_deaths) / 83240000) * 100

p_us <- (sum(ds.covid.info_us$cumulative_total_deaths) / 329500000) * 100

str(p_ec)

str(p_es)

str(p_de)

str(p_us)
```


### Regresión Lineal

Con el objetivo de realizar futuras predicciones, se plantea realizar un modelo de regresión lineal utilizando regresores tanto cuantitativos como cualitativos con el que poder realizar predicciones sobre las muertes acumuladas.
Por tanto, vamos a proceder creando varios modelos de regresión utilizando las variables que estén más correlacionadas con las muertes acumuladas, como ya lo vimos en apartados anteriores. Una vez planteados los modelos, podremos escoger el mejor utilizando como criterio de mayor coeficiente de determinación (R2).

```{r message= FALSE, warning=FALSE}

cumulative_total_deaths = ds.covid.cst$cumulative_total_deaths
cumulative_total_cases = ds.covid.cst$cumulative_total_cases
active_cases = ds.covid.cst$active_cases
daily_new_cases = ds.covid.cst$daily_new_cases
daily_new_deaths = ds.covid.cst$daily_new_deaths
daily_vaccinations = ds.covid.cst$daily_vaccinations
country = ds.covid.cst$country
  

model1 <- lm(cumulative_total_deaths ~ cumulative_total_cases + active_cases + daily_new_cases + daily_new_deaths + ds.covid.cst$daily_vaccinations  + country, data = ds.covid.cst)

model2 <- lm(cumulative_total_deaths ~ daily_new_cases + daily_new_deaths + daily_vaccinations  + country, data = ds.covid.cst)

model3 <- lm(cumulative_total_deaths ~ cumulative_total_cases + active_cases + country, data = ds.covid.cst)

model4 <- lm(cumulative_total_deaths ~ active_cases + daily_new_cases + daily_vaccinations  + country, data = ds.covid.cst)

model5 <- lm(cumulative_total_deaths ~ cumulative_total_cases + daily_new_cases + daily_vaccinations  + country, data = ds.covid.cst)

```

Una vez planteados los modelos con las diferentes combinaciones de variables, continuamos con la comparativa de los coeficientes R2. 


```{r message= FALSE, warning=FALSE}

coeficients_table <- matrix(c(1, summary(model1)$r.squared,
                              2, summary(model2)$r.squared,
                              3, summary(model3)$r.squared,
                              4, summary(model4)$r.squared,
                              5, summary(model5)$r.squared),
                              ncol = 2, byrow = TRUE)


colnames(coeficients_table) <- c("Modelo", "R^2")
coeficients_table
```

Como vemos, al final la mejor combinación, es el primer modelo, que usa todas las variables, sin embargo, el quinto modelo, donde prescindimos de los casos activos, está muy cerca del resultado del modelo 1, por lo que podemos concluir que esa variable realmente no es tan importante a pesar que guarda una alta correlación con el número de muertes acumuladas.


# Conclusiones

En esta práctica, se han cumplido los objetivos del curso, al haber puesto en práctica todo lo aprendido en la materia, empezando desde la preparación de los datos, eliminando valores nulos, filtrando, reordenando las columnas y juntándolos en un nuevo dataset que puede ser usado por cualquiera persona interesada en ampliar su conocimiento.
Como hemos podido observar, se han realizado varios tipos de pruebas estadísticas sobre el dataset construido a partir de dos datasets más pequeños, que nos ha permitido tener una visión más amplia del problema que nos ha permitido en lo posible cumplir con el objetivo propuesto inicialmente. 
Mediante cálculos, tablas y gráficos hemos podido ver las principales variables que afectan en la incidencia de muertes causadas por Covid-19, su contraste y los modelos que mejor se adaptarían para predecir futuros comportamientos de la pandemia. 
Para concluir, hemos visto que el Ecuador dentro todo y a pesar de ser un país subdesarrollado, frente a otros países que los hemos comparado, como las naciones hermanas de España, Alemania y Estados Unidos, lo ha hecho relativamente bien en el año 2021 en lo que fue la tercera y cuarta ola de la pandemia. Confirmando el hecho de que otros factores como la gestión de los gobiernos y factores culturales tienen también una relativa importancia en el problema.


# Recursos

- Guitart Hormigo, I. (2019). Introducción a la limpieza y análisis de los datos. In L. Subirats Maté, D. O. Pérez Trenard, & M. Calvo González. Barcelona: UOC.

- Guitart Hormigo, I. (2019). Introducción al ciclo de vida de los datos. In L. Subirats Maté, D. O. Pérez Trenard, & M. Calvo González. Barcelona: UOC.






